import React, { useState, useEffect, useRef } from 'react';
import { Send, Bot, User, Terminal, Loader, Zap } from 'lucide-react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';

export const ChatInterface = ({ language = 'english' }) => {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [config, setConfig] = useState({ models: {} });
    const [selectedModel, setSelectedModel] = useState('');
    const [enableTools, setEnableTools] = useState(true); // Keeping for legacy toggle if needed, or sync with config
    const [showSettings, setShowSettings] = useState(false);
    const [toolConfig, setToolConfig] = useState({
        web_search: true,
        file_system: true,
        shell: false
    });
    const [status, setStatus] = useState('idle'); // idle, connecting, streaming, error
    const wsRef = useRef(null);
    const messagesEndRef = useRef(null);

    // Fetch Config on Mount
    useEffect(() => {
        fetch('http://127.0.0.1:8000/api/config')
            .then(res => res.json())
            .then(data => {
                setConfig(data);
                if (data.models) setSelectedModel(Object.values(data.models)[0]);
            })
            .catch(console.error);
    }, []);

    // Connect WebSocket
    const connectWs = () => {
        if (wsRef.current && (wsRef.current.readyState === WebSocket.OPEN || wsRef.current.readyState === WebSocket.CONNECTING)) return;

        console.log("üîå Connecting to Chat WebSocket...");
        const ws = new WebSocket('ws://127.0.0.1:8000/ws/chat');

        ws.onopen = () => {
            console.log('‚úÖ Chat WS Connected');
            setStatus('idle');
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'chat_chunk') {
                    // Start a new message bubble if last one wasn't assistant or if we are starting new stream
                    setMessages(prev => {
                        const last = prev[prev.length - 1];
                        if (last && last.role === 'assistant' && last.isStreaming) {
                            // Append to existing streaming message
                            return [
                                ...prev.slice(0, -1),
                                { ...last, content: last.content + data.content }
                            ];
                        } else {
                            // New chunk but no active stream? Should have started one.
                            // But usually we start the 'assistant' bubble when we send the user message.
                            return [...prev, { role: 'assistant', content: data.content, isStreaming: true }];
                        }
                    });
                } else if (data.type === 'chat_end') {
                    setStatus('idle');
                    setMessages(prev => {
                        const last = prev[prev.length - 1];
                        if (last && last.role === 'assistant') {
                            return [...prev.slice(0, -1), { ...last, isStreaming: false }];
                        }
                        return prev;
                    });
                } else if (data.type === 'error') {
                    setMessages(prev => [...prev, { role: 'system', content: `‚ùå Error: ${data.message}` }]);
                    setStatus('idle');
                }
            } catch (err) {
                console.error("Chat WS Parse Error:", err);
            }
        };

        ws.onerror = (err) => {
            console.error("Chat WS Error:", err);
            setStatus('error');
        };

        ws.onclose = () => {
            console.log("Chat WS Disconnected");
            // Optional reconnect logic could go here
        };

        wsRef.current = ws;
    };

    useEffect(() => {
        connectWs();
        return () => {
            if (wsRef.current) wsRef.current.close();
        };
    }, []);

    const sendMessage = () => {
        if (!input.trim() || status === 'streaming') return;

        const userMsg = input;
        setInput('');
        setStatus('streaming');

        // Add User Message
        setMessages(prev => [...prev, { role: 'user', content: userMsg }]);

        // Add Placeholder Assistant Message
        setMessages(prev => [...prev, { role: 'assistant', content: '', isStreaming: true }]);

        // Send to Backend
        if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
            wsRef.current.send(JSON.stringify({
                message: userMsg,
                model: selectedModel,
                enable_tools: enableTools,
                language: language
            }));
        } else {
            console.error("WS not open, trying to reconnect...");
            // Reconnect and maybe retry? For now specific error.
            setMessages(prev => [...prev, { role: 'system', content: "‚ùå Connection lost. Please retry." }]);
            setStatus('idle');
        }
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };

    return (
        <div style={{ display: 'flex', flexDirection: 'column', height: '100%', background: '#09090b', color: '#e4e4e7', fontFamily: 'Inter, sans-serif' }}>

            {/* Top Bar - Minimal */}
            <div style={{ padding: '1rem 2rem', display: 'flex', justifyContent: 'flex-end', alignItems: 'center', borderBottom: '1px solid #27272a' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                    {/* Model Selector Pill */}
                    <div style={{ position: 'relative', display: 'flex', alignItems: 'center' }}>
                        <select
                            value={selectedModel}
                            onChange={(e) => setSelectedModel(e.target.value)}
                            style={{
                                appearance: 'none',
                                background: '#18181b',
                                color: '#a1a1aa',
                                border: '1px solid #3f3f46',
                                padding: '0.4rem 1rem',
                                borderRadius: '999px',
                                fontSize: '0.85rem',
                                outline: 'none',
                                cursor: 'pointer',
                                paddingRight: '2rem'
                            }}
                        >
                            {Object.entries(config.models).map(([name, id]) => (
                                <option key={id} value={id}>{name}</option>
                            ))}
                        </select>
                        <div style={{ position: 'absolute', right: '10px', pointerEvents: 'none', color: '#71717a', fontSize: '0.7rem' }}>‚ñº</div>
                    </div>
                </div>
            </div>

            {/* Chat Area */}
            <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '0 1rem' }}>
                <div style={{ width: '100%', maxWidth: '800px', display: 'flex', flexDirection: 'column', flex: 1 }}>

                    {messages.length === 0 ? (
                        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '2rem', minHeight: '400px' }}>
                            <h1 style={{ fontSize: '2.5rem', fontWeight: '600', color: '#fff', textAlign: 'center', margin: 0 }}>
                                Good morning, how can I help you?
                            </h1>

                            {/* Input Container for Empty State */}
                            <div style={{
                                width: '100%',
                                background: '#18181b',
                                border: '1px solid #27272a',
                                borderRadius: '16px',
                                padding: '1rem',
                                boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                            }}>
                                <textarea
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    placeholder="Enter your task and submit it to the Agent..."
                                    style={{
                                        width: '100%',
                                        background: 'transparent',
                                        border: 'none',
                                        outline: 'none',
                                        color: '#fff',
                                        fontSize: '1rem',
                                        resize: 'none',
                                        minHeight: '60px',
                                        marginBottom: '1rem',
                                        fontFamily: 'inherit'
                                    }}
                                />
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        {/* Tools Settings Trigger */}
                                        <button
                                            onClick={() => setShowSettings(true)}
                                            style={{
                                                background: 'transparent',
                                                color: '#71717a',
                                                border: '1px solid #3f3f46',
                                                borderRadius: '8px',
                                                padding: '0.25rem 0.75rem',
                                                fontSize: '0.8rem',
                                                cursor: 'pointer',
                                                display: 'flex', alignItems: 'center', gap: '0.4rem',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            <Zap size={14} /> Tools ({Object.values(toolConfig).filter(Boolean).length})
                                        </button>
                                    </div>
                                    <button
                                        onClick={sendMessage}
                                        disabled={!input.trim()}
                                        style={{
                                            background: '#fff',
                                            color: '#000',
                                            border: 'none',
                                            borderRadius: '8px',
                                            padding: '0.5rem 1rem',
                                            fontSize: '0.9rem',
                                            fontWeight: '600',
                                            cursor: input.trim() ? 'pointer' : 'default',
                                            opacity: input.trim() ? 1 : 0.5,
                                            display: 'flex', alignItems: 'center', gap: '0.5rem'
                                        }}
                                    >
                                        Run <Send size={14} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div style={{ padding: '2rem 0', display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                            {messages.map((msg, idx) => (
                                <div key={idx} style={{ display: 'flex', gap: '1.5rem', flexDirection: msg.role === 'user' ? 'row-reverse' : 'row' }}>
                                    <div style={{
                                        width: '36px', height: '36px', borderRadius: '50%',
                                        background: msg.role === 'user' ? '#3f3f46' : '#fff',
                                        color: msg.role === 'user' ? '#fff' : '#000',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        flexShrink: 0
                                    }}>
                                        {msg.role === 'user' ? <User size={20} /> : <Bot size={20} />}
                                    </div>
                                    <div style={{ flex: 1, maxWidth: '80%', paddingTop: '0.4rem' }}>
                                        <div style={{ fontSize: '0.9rem', fontWeight: '600', marginBottom: '0.5rem', color: '#a1a1aa' }}>
                                            {msg.role === 'user' ? 'You' : 'Assistant'}
                                        </div>
                                        <div className="markdown-body" style={{ color: '#e4e4e7', fontSize: '1rem', lineHeight: '1.6' }}>
                                            {msg.content ? (
                                                <ReactMarkdown
                                                    remarkPlugins={[remarkGfm]}
                                                    components={{
                                                        code({ node, inline, className, children, ...props }) {
                                                            const match = /language-(\w+)/.exec(className || '')
                                                            return !inline && match ? (
                                                                <div style={{ background: '#18181b', padding: '1rem', borderRadius: '8px', margin: '1rem 0', overflowX: 'auto', border: '1px solid #27272a' }}>
                                                                    <code className={className} {...props}>
                                                                        {children}
                                                                    </code>
                                                                </div>
                                                            ) : (
                                                                <code className={className} style={{ background: '#27272a', padding: '0.2rem 0.4rem', borderRadius: '4px', fontSize: '0.85em' }} {...props}>
                                                                    {children}
                                                                </code>
                                                            )
                                                        }
                                                    }}
                                                >
                                                    {msg.content}
                                                </ReactMarkdown>
                                            ) : (
                                                <span style={{ color: '#71717a' }}>Thinking...</span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            <div ref={messagesEndRef} />
                        </div>
                    )}
                </div>
            </div>

            {/* Sticky Input Bar */}
            {messages.length > 0 && (
                <div style={{ padding: '1.5rem', display: 'flex', justifyContent: 'center', background: 'linear-gradient(to top, #09090b 80%, transparent)' }}>
                    <div style={{
                        width: '100%', maxWidth: '800px',
                        background: '#18181b',
                        border: '1px solid #27272a',
                        borderRadius: '16px',
                        padding: '0.75rem',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
                        display: 'flex', alignItems: 'center', gap: '1rem'
                    }}>
                        <textarea
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyDown={handleKeyDown}
                            placeholder="Message Agent..."
                            style={{
                                flex: 1,
                                background: 'transparent',
                                border: 'none',
                                outline: 'none',
                                color: '#fff',
                                fontSize: '1rem',
                                resize: 'none',
                                maxHeight: '120px',
                                fontFamily: 'inherit',
                                padding: '0.5rem'
                            }}
                            rows={1}
                        />
                        <button
                            onClick={() => setShowSettings(true)}
                            style={{
                                color: '#52525b',
                                background: 'transparent',
                                border: 'none',
                                cursor: 'pointer',
                                padding: '0.5rem',
                                borderRadius: '6px'
                            }}
                            title="Tools Settings"
                        >
                            <Zap size={20} />
                        </button>
                        <button
                            onClick={sendMessage}
                            disabled={status === 'streaming' || !input.trim()}
                            style={{
                                background: input.trim() ? '#fff' : '#27272a',
                                color: input.trim() ? '#000' : '#52525b',
                                border: 'none',
                                borderRadius: '8px',
                                padding: '0.5rem',
                                width: '36px', height: '36px',
                                cursor: input.trim() ? 'pointer' : 'default',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                transition: 'all 0.2s'
                            }}
                        >
                            {status === 'streaming' ? <Loader className="animate-spin" size={18} /> : <Send size={18} />}
                        </button>
                    </div>
                </div>
            )}

            {/* Settings Modal */}
            {showSettings && (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    background: 'rgba(0,0,0,0.7)', backdropFilter: 'blur(4px)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    zIndex: 1000
                }} onClick={() => setShowSettings(false)}>
                    <div style={{
                        background: '#18181b', border: '1px solid #3f3f46', borderRadius: '16px',
                        padding: '1.5rem', width: '300px', maxWidth: '90%'
                    }} onClick={e => e.stopPropagation()}>
                        <h3 style={{ margin: '0 0 1rem 0', color: '#fff' }}>Tool Configuration</h3>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <label style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}>
                                <span>üîç Web Search</span>
                                <input
                                    type="checkbox"
                                    checked={toolConfig.web_search}
                                    onChange={e => setToolConfig({ ...toolConfig, web_search: e.target.checked })}
                                />
                            </label>
                            <label style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}>
                                <span>üìÅ File System</span>
                                <input
                                    type="checkbox"
                                    checked={toolConfig.file_system}
                                    onChange={e => setToolConfig({ ...toolConfig, file_system: e.target.checked })}
                                />
                            </label>
                            <label style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}>
                                <span>üêö Shell (Risky)</span>
                                <input
                                    type="checkbox"
                                    checked={toolConfig.shell}
                                    onChange={e => setToolConfig({ ...toolConfig, shell: e.target.checked })}
                                />
                            </label>
                        </div>

                        <div style={{ marginTop: '1.5rem', display: 'flex', justifyContent: 'flex-end' }}>
                            <button
                                onClick={() => setShowSettings(false)}
                                style={{
                                    background: '#fff', color: '#000', border: 'none',
                                    padding: '0.5rem 1rem', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold'
                                }}
                            >
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <style>{`
                .markdown-body p { margin-bottom: 1em; }
                .markdown-body p:last-child { margin-bottom: 0; }
                /* Custom Scrollbar */
                ::-webkit-scrollbar { width: 8px; }
                ::-webkit-scrollbar-track { background: transparent; }
                ::-webkit-scrollbar-thumb { background: #27272a; borderRadius: 4px; }
                ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
            `}</style>
        </div>
    );
};
